WITH token AS (
    SELECT '0x0f758abf9b242daa6b2b5e976d6e00c5aece9b07' AS token_addr
),
-- 1. Находим покупателей в временном окне
window_buyers AS (
    SELECT
        s.origin_from_address AS wallet,
        MIN(s.block_timestamp) AS first_buy_ts
    FROM base.defi.ez_dex_swaps s
    CROSS JOIN token t
    WHERE s.token_out = t.token_addr
      AND s.block_timestamp BETWEEN '2025-07-16 14:00:00' AND '2025-07-16 15:35:00'
    GROUP BY s.origin_from_address
),
-- 2. PnL по конкретному токену
token_pnl AS (
    SELECT
        wb.wallet,
        wb.first_buy_ts,
        SUM(CASE WHEN s.token_out = t.token_addr THEN s.amount_in_usd ELSE 0 END) AS token_buys_usd,
        SUM(CASE WHEN s.token_in = t.token_addr THEN s.amount_out_usd ELSE 0 END) AS token_sells_usd
    FROM base.defi.ez_dex_swaps s
    JOIN window_buyers wb ON s.origin_from_address = wb.wallet
    CROSS JOIN token t
    WHERE s.token_out = t.token_addr OR s.token_in = t.token_addr
    GROUP BY wb.wallet, wb.first_buy_ts
),
-- 3. Общий PnL кошелька по всем токенам
overall_pnl AS (
    SELECT 
        s.origin_from_address AS wallet,
        SUM(CASE WHEN s.token_out != '0x4200000000000000000000000000000000000006' 
            THEN s.amount_in_usd ELSE 0 END) AS overall_buys_usd,
        SUM(CASE WHEN s.token_in != '0x4200000000000000000000000000000000000006' 
            THEN s.amount_out_usd ELSE 0 END) AS overall_sells_usd,
        COUNT(*) AS total_transactions,
        COUNT(DISTINCT DATE(s.block_timestamp)) AS active_days
    FROM base.defi.ez_dex_swaps s
    WHERE s.origin_from_address IN (SELECT wallet FROM window_buyers)
    GROUP BY s.origin_from_address
)

-- 4. Объединяем данные с фильтром и скрытыми колонками
SELECT 
    tp.wallet,
    tp.first_buy_ts AS block_timestamp,
    
    -- Данные по конкретному токену
    tp.token_buys_usd,
    tp.token_sells_usd,
    tp.token_sells_usd - tp.token_buys_usd AS token_pnl_usd,
    
    -- Общие данные кошелька (БЕЗ overall_buys_usd и overall_sells_usd)
    op.overall_sells_usd - op.overall_buys_usd AS overall_pnl_usd,
    CASE WHEN op.overall_buys_usd > 0 
         THEN (op.overall_sells_usd - op.overall_buys_usd) / op.overall_buys_usd * 100 
         ELSE 0 END AS overall_roi_percentage,
    op.total_transactions,
    op.active_days
    
FROM token_pnl tp
JOIN overall_pnl op ON tp.wallet = op.wallet
WHERE tp.token_buys_usd > 0
  AND (op.overall_sells_usd - op.overall_buys_usd) > 20000  -- ФИЛЬТР: Overall PnL > $20,000
ORDER BY token_pnl_usd DESC
LIMIT 30;
